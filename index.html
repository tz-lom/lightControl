<!DOCTYPE html>
<svg width="200" height=200 class="pointInfo"></svg>
<input type="time" id="addTime"><button onClick="addPointWrap()">Add point</button>
<button>Remove point</button>
<svg width="500" height="500" class="timePlot"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<style>
    .active circle { fill: red }
</style>
<script>


var data = [
    {
        id: 0,
        time:0,
        power: 10
    },
/*    {
        id: 1,
        time: 60*10,
        power: 40
    },
    {
        id: 2,
        time: 60*18+15,
        power: 100
    },
    {
        id: 3,
        time: 60*22,
        power: 30
    },*/
    {
        id: 1,
        time: 60*23+59,
        power: 10
    }
]
var svg = d3.select("svg.timePlot"),
    margin = {top: 20, right: 80, bottom: 30, left: 50},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;


let points = data;


var x = d3.scaleTime()
    .domain([new Date(2000, 0, 1,  0), new Date(2000, 0, 2,  0, 0)])
    .rangeRound([0, width])
    //.ticks(24,'s')
    //.tickFormat(d3.timeFormat("%I:%M"))


var y = d3.scaleLinear()
    .domain([0, 100])
    .rangeRound([height, 0]);

var xAxis = d3.axisBottom(x).tickFormat(d3.timeFormat("%H")),
    yAxis = d3.axisLeft(y);

var line = d3.line()
    .x(function(d) { return x(new Date(2000, 0, 1, Math.floor(d.time/60), d.time%60)); })
    .y(function(d) { return y(d.power); });

let drag = d3.drag()
    .on('start', dragstarted)
    .on('drag', dragged)
    .on('end', dragended);
/*
svg.append('rect')
    .attr('class', 'zoom')
    .attr('cursor', 'move')
    .attr('fill', 'none')
    .attr('pointer-events', 'all')
    .attr('width', width)
    .attr('height', height)
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
*/

var focus = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


focus.append("path")
    .datum(points)
    .attr("fill", "none")
    .attr("stroke", "steelblue")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", 1.5)
    .attr("d", line)

function rebuildPlot() {

    focus.select('path').attr('d', line);

    var circleGroup = focus.selectAll('g.point')
        .data(points)
        .enter()
        .filter(function (n, i) {
            return i !== 0;
        })
        .append('g')
        .classed('point', true)
        .attr("transform", function (d) {
            return 'translate(' + x(new Date(2000, 0, 1, Math.floor(d.time / 60), d.time % 60)) + ',' + y(d.power) + ')';
        })
        .call(drag)

    circleGroup
        .append('circle')
        .attr('r', 5.0)
        .style('cursor', 'move')
        .style('fill', 'steelblue')

    circleGroup
        .append('text')
        .attr("x", "10")
        .attr("dy", ".35em")
        .attr("text-anchor", "start")
        .style("fill", "red")
        .text(function (d) {
            return d3.timeFormat('%H:%M')(new Date(2000, 0, 1, Math.floor(d.time / 60), d.time % 60)) + ' ' + d.power.toFixed(0) + '%'
        });
}

rebuildPlot()


focus.append('g')
    .attr('class', 'axis axis--x')
    .attr('transform', 'translate(0,' + height + ')')
    .call(xAxis);

focus.append('g')
    .attr('class', 'axis axis--y')
    .call(yAxis);

function dragstarted(d) {
    d3.select(this).raise().classed('active', true);
}

function dragged(d) {
    var newTime = x.invert(d3.event.x);
    var newPower = y.invert(d3.event.y);

    newTime = Math.ceil((newTime - new Date(2000, 0 ,1))/60000)

    if(newTime<0) newTime = 0;
    if(newTime>=24*60) newTime=24*60-1;


    if(newPower<0) newPower = 0;
    if(newPower>100) newPower = 100;

    if(d.id !== data.length-1) {

        if(d.id>0) {
            if (newTime <= data[d.id-1].time) newTime = data[d.id-1].time + 1
        }
        if(d.id<data.length-1) {
            if (newTime>= data[d.id+1].time) newTime = data[d.id+1].time-1
        }

        d.time = newTime;
        d.power = newPower;



    } else {
        d.power = newPower;
        data[0].power = newPower;
    }

    d3.select(this)
        .attr('transform', 'translate('+x(new Date(2000, 0, 1, Math.floor(d.time/60), d.time%60))+','+y(d.power)+')')
//        .attr('cx', x(new Date(2000, 0, 1, Math.floor(d.time/60), d.time%60)))
//        .attr('cy', y(d.power))
    d3.select(this).select('text').text(function(d){ return d3.timeFormat('%H:%M')(new Date(2000, 0, 1, Math.floor(d.time/60), d.time%60))+ ' ' + d.power.toFixed(0)+'%' })
    focus.select('path').attr('d', line);
}

function dragended(d) {
    d3.select(this).classed('active', false);
}


function addPoint(time){
    if(time<=0 || time >= 60*23+59) return;

    for(var i=0; i<data.length; ++i) {
        if(data[i].time === time) {
            time++;
            continue;
        }
        if(data[i].time > time){
            data.splice(i, 0, { time: time, power: 50 } )
            break;
        }

    }
    data.forEach(function(n, i) { n.id = i })


    focus.selectAll('g.point').remove()

    rebuildPlot()

}


function addPointWrap(){
    addPoint(document.getElementById('addTime').valueAsNumber/60000)
}

var currentPoint = points.length-1;

function buildPointInfoPlot() {
    var svg = d3.select("svg.pointInfo")

    var margin = {top: 20, right: 80, bottom: 30, left: 50},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;


    var focus = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var powerScale = d3.scaleLinear()
        .domain([0, 100])
        .rangeRound([height, 0]);

    var powerAxis = d3.axisLeft(powerScale);

    focus.append("g").call(powerAxis)

    var loScale
}

function updatePointInfo(){
    var svg = d3.select("svg.pointInfo");
    svg.selectAll("circle").attr("cx")
}

buildPointInfoPlot()

</script>
